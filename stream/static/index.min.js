(function(){'usestrict';function__$styleInject(css,returnValue){if(typeofdocument==='undefined'){returnreturnValue;}css=css||'';varhead=document.head||document.getElementsByTagName('head')[0];varstyle=document.createElement('style');style.type='text/css';head.appendChild(style);if(style.styleSheet){style.styleSheet.cssText=css;}else{style.appendChild(document.createTextNode(css));}returnreturnValue;}__$styleInject("body,html{padding:0;margin:0}body{font-size:15px;font-family:PingFangSC-Regular,HelveticaNeue,Helvetica,Roboto,DroidSansFallback,MicrosoftYaHei,sans-serif}.btn{display:inline-block;padding:10px20px;border-radius:3px;background:#f55;color:#fff;cursor:pointer}.btn:hover{opacity:.8}#textCanvas{display:none}#canvas{display:block;margin:10pxauto;border:2pxsolid#999}.input-con{width:300px;margin:20pxauto}.input-coninput{height:30px;width:150px;padding:5px10px;margin:0}.content{font-size:20px}.content,.ctrl{text-align:center}.ctrl{display:block;width:100px;margin:10pxauto}",undefined);varRadius=3;varCellWidth=8;varG=5;//px/framevarCWidth=CellWidth*90;varCHeight=CellWidth*25;varColorList=['#33B5E5','#0099CC','#AA66CC','#9933CC','#99CC00','#669900','#FFBB33','#FF8800','#FF4444','#CC0000'];varDefaultColor='#f55';varElas=0.7;//弹性系数functiongetV(){varv=arguments.length>0&&arguments[0]!==undefined?arguments[0]:3;varrange=arguments.length>1&&arguments[1]!==undefined?arguments[1]:2;varresult=parseInt(Math.random()*(2*range+1))+v-range;returnMath.random()<0.5?-result:result;}functiongetColor(){returnColorList[parseInt(Math.random()*ColorList.length)];}functioncheckDraw(x,y){//move-1didnotneeddraw0normal1if(x<-Radius||x>CWidth+Radius){return-1;}elseif(y<-Radius){return0;}return1;}//canvaswidth8*90height8*25varManager={list:{},drawList:[],emit:functionemit(event,data){//drawremoveaddthis['_'+event](data);},_add:function_add(ball){varkey=this._getKey();ball.key=key;this.list[key]=ball;},_draw:function_draw(key){this.drawList.push(key);},_remove:function_remove(key){deletethis.list[key];},_getKey:function_getKey(){varkey=Math.random();while(keyinthis.list){key=Math.random()+'-'+Math.random();}returnkey;},drawAll:functiondrawAll(ctx){var_this=this;this.drawList.forEach(function(ind){varball=_this.list[ind];if(!ball)return;ctx.fillStyle=ball.color;drawBall(ctx,ball.x,ball.y);});this.drawList=[];Object.keys(this.list).forEach(function(key){if(_this.list[key]){_this.list[key].change();}});}};functionBall(x,y,manager){this.vx=getV(5,2);this.vy=getV();this.color=getColor();this.x=x;this.y=y;this.key=-1;this.manager=manager;}Ball.prototype.change=function(){this.x+=this.vx;this.y+=this.vy;vardirection=1;//1bottom-1topif(this.y>CHeight-Radius){direction=-1;this.y=CHeight-Radius;}varstatus=checkDraw(this.x,this.y);if(status===-1){//emitremovethis.manager.emit('remove',this.key);}else{if(direction===1){this.vy+=G;}else{this.vy=-this.vy*Elas;}//emitdrawthis.manager.emit('draw',this.key);}};functiondrawBall(ctx,x,y){ctx.beginPath();ctx.arc(x,y,Radius,0,Math.PI*2,true);ctx.closePath();ctx.fill();}functiondrawAllBall(ctx,mapArr){varaddBall=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;ctx.clearRect(0,0,CWidth,CHeight);if(mapArr){ctx.fillStyle=DefaultColor;mapArr.forEach(function(arr,indY){arr.forEach(function(item,indX){if(item===1){varx=indX*CellWidth+CellWidth/2;vary=indY*CellWidth+CellWidth/2;addBall&&Manager.emit('add',newBall(x,y,Manager));drawBall(ctx,x,y);}});});}Manager.drawAll(ctx);}varFontSize=18;varRed=255;varGreen=255;varBlue=255;varCoef=0.75;//canvaswidth90height25functiondrawText(ctx,text){ctx.clearRect(0,0,90,25);ctx.font='300'+FontSize+'pxSimHei';ctx.textBaseline='top';ctx.fillStyle='rgba('+Red+','+Green+','+Blue+',255)';ctx.fillText(text,0,0);}functiongetMapArr(ctx,length){varimageData=ctx.getImageData(0,0,length*FontSize,parseInt(FontSize*1.4));varrgbaArr=[];varmapArr=[];varr=Red*Coef,g=Green*Coef,b=Blue*Coef,l=length*FontSize;imageData.data.forEach(function(item,ind){if(ind%4===0){rgbaArr[rgbaArr.length]=[item];}else{rgbaArr[rgbaArr.length-1].push(item);}});rgbaArr.map(function(item,ind){if(item[0]>=r&&item[1]>=g&&item[2]>=b&&item[3]>179){return1;}else{return0;}}).forEach(function(item,ind){if(ind%l===0){mapArr[ind/l]=[item];}else{mapArr[mapArr.length-1].push(item);}});//mapArr.forEach(item=>{//console.log(item.join('').replace(/0/g,'').replace(/1/g,'*'))//})returnmapArr;}window.addEventListener('load',function(){varctx=document.getElementById('canvas').getContext('2d');vartextCtx=document.getElementById('textCanvas').getContext('2d');varinput=document.getElementById('input');varbtn=document.getElementById('btn');varcon=document.getElementById('con');varcontrol=document.getElementById('control');varmapArrList=[];vartimer=null;varcount=0;btn.addEventListener('click',function(){if(input.value.length===0){alert('请输入文字');}else{vartext=input.value;mapArrList.push(getMapItem(text));con.innerHTML+=text+'<br/>';input.value='';}});control.addEventListener('click',function(e){if(e.target.innerHTML==='开始'){if(mapArrList.length===0){alert('请输入文字');return;}e.target.innerHTML='暂停';start();}else{e.target.innerHTML='开始';stop();}});functionstart(){varcache=void0;timer=setInterval(function(){vararr=[];varaddBall=true;varc=count%50;if(c===0){vari=count/50;if(i>=mapArrList.length){i=i%mapArrList.length;}arr=mapArrList[i];cache=arr;}elseif(c<5){arr=cache;addBall=false;}count++;drawAllBall(ctx,arr,addBall);},50);}functionstop(){clearInterval(timer);}functiongetMapItem(text){drawText(textCtx,text);returngetMapArr(textCtx,text.length);}});}());